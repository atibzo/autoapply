
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LinkedIn Auto Job Applier</title>
    <style>
        :root {
            --primary-color: #0073b1;
            --secondary-color: #f3f2ef;
            --text-color: #333;
            --border-color: #ddd;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 0; color: var(--text-color); background: #f9f9f9; }
        
        /* Layout */
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        
        /* Tabs */
        .tabs { display: flex; border-bottom: 1px solid var(--border-color); background: white; padding: 0 20px; }
        .tab { padding: 15px 20px; cursor: pointer; border-bottom: 3px solid transparent; font-weight: 600; color: #666; }
        .tab.active { border-bottom-color: var(--primary-color); color: var(--primary-color); }
        .tab:hover { color: var(--primary-color); }
        
        /* Content */
        .tab-content { display: none; padding: 20px; background: white; min-height: 80vh; }
        .tab-content.active { display: block; }
        
        /* Forms */
        .form-section { margin-bottom: 30px; border: 1px solid var(--border-color); padding: 20px; border-radius: 8px; }
        .form-section h3 { margin-top: 0; border-bottom: 1px solid #eee; padding-bottom: 10px; color: var(--primary-color); }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 500; }
        .form-group input[type="text"], .form-group input[type="number"], .form-group input[type="password"], .form-group select, .form-group textarea {
            width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;
        }
        .form-group textarea { height: 100px; resize: vertical; }
        .form-group .checkbox-label { display: flex; align-items: center; cursor: pointer; }
        .form-group input[type="checkbox"] { margin-right: 10px; width: auto; }
        
        /* Buttons */
        .btn { padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 14px; }
        .btn-primary { background: var(--primary-color); color: white; }
        .btn-danger { background: #d9534f; color: white; }
        .btn-success { background: #5cb85c; color: white; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        
        /* Dashboard Table */
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid var(--border-color); padding: 12px; text-align: left; }
        th { background-color: var(--secondary-color); }
        tr:nth-child(even) { background-color: #f8f8f8; }
        .status-pill { padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: bold; }
        .status-pill.running { background: #e6fffa; color: #047481; }
        .status-pill.stopped { background: #fff5f5; color: #c53030; }

        /* Modal */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: white; margin: 15% auto; padding: 20px; border-radius: 8px; width: 50%; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .modal-header { font-size: 1.2rem; font-weight: bold; margin-bottom: 15px; }
        .modal-footer { margin-top: 20px; text-align: right; }

        /* Control Panel */
        .control-panel { display: flex; align-items: center; justify-content: space-between; background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .status-indicator { display: flex; align-items: center; gap: 10px; }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; background: #ccc; }
        .status-dot.active { background: #48bb78; box-shadow: 0 0 5px #48bb78; }

        /* Helper */
        .help-text { font-size: 0.85em; color: #666; margin-top: 4px; }
    </style>
</head>
<body>

    <div class="tabs">
        <div class="tab active" onclick="switchTab('dashboard')">Dashboard</div>
        <div class="tab" onclick="switchTab('config-personal')">Personal Info</div>
        <div class="tab" onclick="switchTab('config-search')">Job Search</div>
        <div class="tab" onclick="switchTab('config-questions')">Questions & Answers</div>
        <div class="tab" onclick="switchTab('config-secrets')">Credentials & AI</div>
        <div class="tab" onclick="switchTab('config-settings')">Settings</div>
    </div>

    <div class="container">
        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <div class="control-panel">
                <div class="status-indicator">
                    <div id="botStatusDot" class="status-dot"></div>
                    <span id="botStatusText">Bot is stopped</span>
                </div>
                <div>
                    <button id="startBtn" class="btn btn-success" onclick="startBot()">Start Bot</button>
                    <button id="stopBtn" class="btn btn-danger" onclick="stopBot()" disabled>Stop Bot</button>
                </div>
            </div>

            <h2>Applied Jobs History</h2>
            <table id="jobsTable">
                <thead>
                    <tr>
                        <th>Sl No</th>
                        <th>Job Title</th>
                        <th>Company</th>
                        <th>HR Contact</th>
                        <th>External Link</th>
                        <th>Applied</th>
                    </tr>
                </thead>
                <tbody id="jobsBody"></tbody>
            </table>
        </div>

        <!-- Personal Info Config -->
        <div id="config-personal" class="tab-content">
            <div class="form-section">
                <h3>Identity</h3>
                <div class="form-group"><label>First Name</label><input type="text" id="p_first_name"></div>
                <div class="form-group"><label>Middle Name</label><input type="text" id="p_middle_name"></div>
                <div class="form-group"><label>Last Name</label><input type="text" id="p_last_name"></div>
                <div class="form-group"><label>Phone Number</label><input type="text" id="p_phone_number"></div>
            </div>
            <div class="form-section">
                <h3>Location</h3>
                <div class="form-group"><label>Current City</label><input type="text" id="p_current_city"></div>
                <div class="form-group"><label>Street</label><input type="text" id="p_street"></div>
                <div class="form-group"><label>State</label><input type="text" id="p_state"></div>
                <div class="form-group"><label>Zipcode</label><input type="text" id="p_zipcode"></div>
                <div class="form-group"><label>Country</label><input type="text" id="p_country"></div>
            </div>
            <div class="form-section">
                <h3>Demographics (Optional)</h3>
                <div class="form-group"><label>Ethnicity</label><select id="p_ethnicity"><option value="Decline">Decline</option><option value="White">White</option><option value="Hispanic/Latino">Hispanic/Latino</option><option value="Black or African American">Black or African American</option><option value="Asian">Asian</option></select></div>
                <div class="form-group"><label>Gender</label><select id="p_gender"><option value="Decline">Decline</option><option value="Male">Male</option><option value="Female">Female</option></select></div>
                <div class="form-group"><label>Disability Status</label><select id="p_disability_status"><option value="Decline">Decline</option><option value="Yes">Yes</option><option value="No">No</option></select></div>
                <div class="form-group"><label>Veteran Status</label><select id="p_veteran_status"><option value="Decline">Decline</option><option value="Yes">Yes</option><option value="No">No</option></select></div>
            </div>
            <button class="btn btn-primary" onclick="saveConfiguration()">Save Changes</button>
        </div>

        <!-- Search Config -->
        <div id="config-search" class="tab-content">
            <div class="form-section">
                <h3>Search Criteria</h3>
                <div class="form-group">
                    <label>Search Terms (comma separated)</label>
                    <textarea id="s_search_terms" placeholder="Software Engineer, Developer..."></textarea>
                    <div class="help-text">Enter job titles to search for</div>
                </div>
                <div class="form-group"><label>Location</label><input type="text" id="s_search_location"></div>
            </div>
             <div class="form-section">
                <h3>Filters</h3>
                <div class="form-group"><label>Date Posted</label><select id="s_date_posted"><option value="Any time">Any time</option><option value="Past month">Past month</option><option value="Past week">Past week</option><option value="Past 24 hours">Past 24 hours</option></select></div>
                <div class="form-group"><label>Sort By</label><select id="s_sort_by"><option value="">Default</option><option value="Most recent">Most recent</option><option value="Most relevant">Most relevant</option></select></div>
                <div class="form-group"><label class="checkbox-label"><input type="checkbox" id="s_easy_apply_only"> Easy Apply Only</label></div>
            </div>
            <div class="form-section">
                <h3>Exclusions</h3>
                 <div class="form-group">
                    <label>Bad Words (Job Description)</label>
                    <textarea id="s_bad_words"></textarea>
                </div>
            </div>
            <button class="btn btn-primary" onclick="saveConfiguration()">Save Changes</button>
        </div>

        <!-- Questions Config -->
        <div id="config-questions" class="tab-content">
             <div class="form-section">
                <h3>Standard Answers</h3>
                <div class="form-group"><label>Years of Experience</label><input type="number" id="q_years_of_experience"></div>
                <div class="form-group"><label>Requires Visa?</label><select id="q_require_visa"><option value="No">No</option><option value="Yes">Yes</option></select></div>
                <div class="form-group"><label>LinkedIn URL</label><input type="text" id="q_linkedIn"></div>
                <div class="form-group"><label>Portfolio/Website</label><input type="text" id="q_website"></div>
            </div>
            <div class="form-section">
                <h3>Compensation & Notice</h3>
                <div class="form-group"><label>Desired Salary</label><input type="number" id="q_desired_salary"></div>
                <div class="form-group"><label>Current CTC</label><input type="number" id="q_current_ctc"></div>
                <div class="form-group"><label>Notice Period (days)</label><input type="number" id="q_notice_period"></div>
            </div>
            <div class="form-section">
                <h3>Free Text</h3>
                <div class="form-group"><label>Headline</label><input type="text" id="q_linkedin_headline"></div>
                <div class="form-group"><label>Summary</label><textarea id="q_linkedin_summary"></textarea></div>
                <div class="form-group"><label>Cover Letter</label><textarea id="q_cover_letter"></textarea></div>
            </div>
             <button class="btn btn-primary" onclick="saveConfiguration()">Save Changes</button>
        </div>

        <!-- Secrets Config -->
        <div id="config-secrets" class="tab-content">
            <div class="form-section">
                <h3>LinkedIn Credentials</h3>
                <div class="form-group"><label>Username</label><input type="text" id="sec_username"></div>
                <div class="form-group"><label>Password</label><input type="password" id="sec_password"></div>
            </div>
            <div class="form-section">
                <h3>AI Configuration</h3>
                <div class="form-group"><label class="checkbox-label"><input type="checkbox" id="sec_use_AI"> Use AI</label></div>
                <div class="form-group"><label>Provider</label><select id="sec_ai_provider"><option value="openai">OpenAI</option><option value="deepseek">DeepSeek</option><option value="gemini">Gemini</option></select></div>
                <div class="form-group"><label>API Key</label><input type="password" id="sec_llm_api_key"></div>
                <div class="form-group"><label>Model</label><input type="text" id="sec_llm_model" placeholder="gpt-4o, etc."></div>
                <div class="form-group"><label>API URL</label><input type="text" id="sec_llm_api_url"></div>
            </div>
            <button class="btn btn-primary" onclick="saveConfiguration()">Save Changes</button>
        </div>

        <!-- Settings Config -->
        <div id="config-settings" class="tab-content">
            <div class="form-section">
                <h3>Behavior</h3>
                <div class="form-group"><label class="checkbox-label"><input type="checkbox" id="set_run_in_background"> Run in Background (Headless)</label></div>
                <div class="form-group"><label class="checkbox-label"><input type="checkbox" id="set_stealth_mode"> Stealth Mode</label></div>
                <div class="form-group"><label class="checkbox-label"><input type="checkbox" id="set_keep_screen_awake"> Keep Screen Awake</label></div>
                <div class="form-group"><label class="checkbox-label"><input type="checkbox" id="set_follow_companies"> Follow Companies</label></div>
                <div class="form-group"><label class="checkbox-label"><input type="checkbox" id="set_disable_extensions"> Disable Extensions</label></div>
                 <div class="form-group"><label>Click Gap (seconds)</label><input type="number" id="set_click_gap"></div>
            </div>
            <button class="btn btn-primary" onclick="saveConfiguration()">Save Changes</button>
        </div>

    </div>

    <!-- Interaction Modal -->
    <div id="interactionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">Bot Needs Input</div>
            <div id="interactionPrompt">The bot needs your input for a field.</div>
            <div class="form-group">
                <textarea id="interactionInput" style="height: 200px; width: 100%; margin-top: 10px;"></textarea>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="submitInteraction()">Submit</button>
            </div>
        </div>
    </div>

    <script>
        let fullConfig = {};
        
        // --- Tab Switching ---
        function switchTab(tabId) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            document.querySelector(`.tab[onclick="switchTab('${tabId}')"]`).classList.add('active');
            document.getElementById(tabId).classList.add('active');
        }

        // --- Config Loading ---
        async function loadConfiguration() {
            try {
                const res = await fetch('/api/config');
                fullConfig = await res.json();
                populateForms(fullConfig);
            } catch (e) {
                console.error("Failed to load config", e);
            }
        }

        function populateForms(config) {
            // Personal
            const p = config.personals || {};
            setVal('p_first_name', p.first_name);
            setVal('p_middle_name', p.middle_name);
            setVal('p_last_name', p.last_name);
            setVal('p_phone_number', p.phone_number);
            setVal('p_current_city', p.current_city);
            setVal('p_street', p.street);
            setVal('p_state', p.state);
            setVal('p_zipcode', p.zipcode);
            setVal('p_country', p.country);
            setVal('p_ethnicity', p.ethnicity);
            setVal('p_gender', p.gender);
            setVal('p_disability_status', p.disability_status);
            setVal('p_veteran_status', p.veteran_status);

            // Search
            const s = config.search || {};
            setVal('s_search_terms', (s.search_terms || []).join(', '));
            setVal('s_search_location', s.search_location);
            setVal('s_date_posted', s.date_posted);
            setVal('s_sort_by', s.sort_by);
            setCheck('s_easy_apply_only', s.easy_apply_only);
            setVal('s_bad_words', (s.bad_words || []).join(', '));

            // Questions
            const q = config.questions || {};
            setVal('q_years_of_experience', q.years_of_experience);
            setVal('q_require_visa', q.require_visa);
            setVal('q_linkedIn', q.linkedIn);
            setVal('q_website', q.website);
            setVal('q_desired_salary', q.desired_salary);
            setVal('q_current_ctc', q.current_ctc);
            setVal('q_notice_period', q.notice_period);
            setVal('q_linkedin_headline', q.linkedin_headline);
            setVal('q_linkedin_summary', q.linkedin_summary);
            setVal('q_cover_letter', q.cover_letter);

            // Secrets
            const sec = config.secrets || {};
            setVal('sec_username', sec.username);
            setVal('sec_password', sec.password);
            setCheck('sec_use_AI', sec.use_AI);
            setVal('sec_ai_provider', sec.ai_provider);
            setVal('sec_llm_api_key', sec.llm_api_key);
            setVal('sec_llm_model', sec.llm_model);
            setVal('sec_llm_api_url', sec.llm_api_url);

            // Settings
            const set = config.settings || {};
            setCheck('set_run_in_background', set.run_in_background);
            setCheck('set_stealth_mode', set.stealth_mode);
            setCheck('set_keep_screen_awake', set.keep_screen_awake);
            setCheck('set_follow_companies', set.follow_companies);
            setCheck('set_disable_extensions', set.disable_extensions);
            setVal('set_click_gap', set.click_gap);
        }

        // --- Config Saving ---
        async function saveConfiguration() {
            // Update config object from forms
            
            // Personal
            fullConfig.personals = fullConfig.personals || {};
            fullConfig.personals.first_name = getVal('p_first_name');
            fullConfig.personals.middle_name = getVal('p_middle_name');
            fullConfig.personals.last_name = getVal('p_last_name');
            fullConfig.personals.phone_number = getVal('p_phone_number');
            fullConfig.personals.current_city = getVal('p_current_city');
            fullConfig.personals.street = getVal('p_street');
            fullConfig.personals.state = getVal('p_state');
            fullConfig.personals.zipcode = getVal('p_zipcode');
            fullConfig.personals.country = getVal('p_country');
            fullConfig.personals.ethnicity = getVal('p_ethnicity');
            fullConfig.personals.gender = getVal('p_gender');
            fullConfig.personals.disability_status = getVal('p_disability_status');
            fullConfig.personals.veteran_status = getVal('p_veteran_status');

            // Search
            fullConfig.search = fullConfig.search || {};
            fullConfig.search.search_terms = getVal('s_search_terms').split(',').map(t => t.trim()).filter(t => t);
            fullConfig.search.search_location = getVal('s_search_location');
            fullConfig.search.date_posted = getVal('s_date_posted');
            fullConfig.search.sort_by = getVal('s_sort_by');
            fullConfig.search.easy_apply_only = getCheck('s_easy_apply_only');
            fullConfig.search.bad_words = getVal('s_bad_words').split(',').map(t => t.trim()).filter(t => t);

            // Questions
            fullConfig.questions = fullConfig.questions || {};
            fullConfig.questions.years_of_experience = getVal('q_years_of_experience');
            fullConfig.questions.require_visa = getVal('q_require_visa');
            fullConfig.questions.linkedIn = getVal('q_linkedIn');
            fullConfig.questions.website = getVal('q_website');
            fullConfig.questions.desired_salary = getVal('q_desired_salary');
            fullConfig.questions.current_ctc = getVal('q_current_ctc');
            fullConfig.questions.notice_period = getVal('q_notice_period');
            fullConfig.questions.linkedin_headline = getVal('q_linkedin_headline');
            fullConfig.questions.linkedin_summary = getVal('q_linkedin_summary');
            fullConfig.questions.cover_letter = getVal('q_cover_letter');

            // Secrets
            fullConfig.secrets = fullConfig.secrets || {};
            fullConfig.secrets.username = getVal('sec_username');
            fullConfig.secrets.password = getVal('sec_password');
            fullConfig.secrets.use_AI = getCheck('sec_use_AI');
            fullConfig.secrets.ai_provider = getVal('sec_ai_provider');
            fullConfig.secrets.llm_api_key = getVal('sec_llm_api_key');
            fullConfig.secrets.llm_model = getVal('sec_llm_model');
            fullConfig.secrets.llm_api_url = getVal('sec_llm_api_url');

            // Settings
            fullConfig.settings = fullConfig.settings || {};
            fullConfig.settings.run_in_background = getCheck('set_run_in_background');
            fullConfig.settings.stealth_mode = getCheck('set_stealth_mode');
            fullConfig.settings.keep_screen_awake = getCheck('set_keep_screen_awake');
            fullConfig.settings.follow_companies = getCheck('set_follow_companies');
            fullConfig.settings.disable_extensions = getCheck('set_disable_extensions');
            fullConfig.settings.click_gap = parseInt(getVal('set_click_gap'));

            try {
                await fetch('/api/config', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(fullConfig)
                });
                alert('Configuration saved!');
            } catch (e) {
                alert('Error saving config');
                console.error(e);
            }
        }

        // --- Bot Control ---
        async function startBot() {
            try {
                document.getElementById('startBtn').disabled = true;
                document.getElementById('startBtn').innerText = 'Starting...';
                
                const res = await fetch('/api/bot/start', {method: 'POST'});
                const data = await res.json();
                
                if (res.ok) {
                    updateBotStatus(true);
                    hideError();
                } else {
                    updateBotStatus(false);
                    showError(data);
                }
            } catch (e) {
                console.error(e);
                updateBotStatus(false);
                showError({
                    error: "Connection failed",
                    details: ["Could not connect to the backend server. Make sure the Flask server is running."],
                    suggestion: "Run: python app.py"
                });
            }
        }
        
        function showError(data) {
            let errorDiv = document.getElementById('errorDisplay');
            if (!errorDiv) {
                errorDiv = document.createElement('div');
                errorDiv.id = 'errorDisplay';
                errorDiv.style.cssText = 'background: #fee2e2; border: 1px solid #ef4444; border-radius: 8px; padding: 20px; margin-bottom: 20px;';
                const controlPanel = document.querySelector('.control-panel');
                controlPanel.parentNode.insertBefore(errorDiv, controlPanel.nextSibling);
            }
            
            let html = `<div style="color: #dc2626; font-weight: bold; font-size: 1.1em; margin-bottom: 10px;">‚ö†Ô∏è ${data.error || 'Error'}</div>`;
            
            if (data.details && data.details.length > 0) {
                html += '<ul style="margin: 10px 0; padding-left: 20px; color: #7f1d1d;">';
                data.details.forEach(detail => {
                    html += `<li style="margin: 5px 0;">${escapeHtml(detail)}</li>`;
                });
                html += '</ul>';
            }
            
            if (data.suggestion) {
                html += `<div style="margin-top: 15px; padding: 10px; background: #fef3c7; border-radius: 4px; color: #92400e;">
                    <strong>üí° Suggestion:</strong> ${escapeHtml(data.suggestion)}
                </div>`;
            }
            
            html += `<button onclick="hideError()" style="margin-top: 10px; padding: 5px 15px; background: #dc2626; color: white; border: none; border-radius: 4px; cursor: pointer;">Dismiss</button>`;
            
            errorDiv.innerHTML = html;
            errorDiv.style.display = 'block';
        }
        
        function hideError() {
            const errorDiv = document.getElementById('errorDisplay');
            if (errorDiv) {
                errorDiv.style.display = 'none';
            }
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function stopBot() {
             try {
                const res = await fetch('/api/bot/stop', {method: 'POST'});
                if (res.ok) {
                    updateBotStatus(false);
                }
            } catch (e) {
                console.error(e);
            }
        }

        function updateBotStatus(isRunning) {
            const dot = document.getElementById('botStatusDot');
            const text = document.getElementById('botStatusText');
            const startBtn = document.getElementById('startBtn');
            const stopBtn = document.getElementById('stopBtn');

            if (isRunning) {
                dot.classList.add('active');
                text.innerText = "Bot is running";
                startBtn.disabled = true;
                startBtn.innerText = "Start Bot";
                stopBtn.disabled = false;
            } else {
                dot.classList.remove('active');
                text.innerText = "Bot is stopped";
                startBtn.disabled = false;
                startBtn.innerText = "Start Bot";
                stopBtn.disabled = true;
            }
        }

        // --- Interaction ---
        async function submitInteraction() {
            const input = document.getElementById('interactionInput').value;
            try {
                await fetch('/api/bot/interact', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({response: input})
                });
                document.getElementById('interactionModal').style.display = 'none';
            } catch (e) {
                console.error(e);
            }
        }

        // --- Polling ---
        setInterval(async () => {
            try {
                const res = await fetch('/api/bot/status');
                const data = await res.json();
                updateBotStatus(data.status === 'running');

                if (data.interaction && data.interaction.status === 'waiting') {
                    const modal = document.getElementById('interactionModal');
                    if (modal.style.display !== 'block') {
                        document.getElementById('interactionPrompt').innerText = data.interaction.prompt || "Bot needs input.";
                        document.getElementById('interactionInput').value = ""; // Clear previous
                        modal.style.display = 'block';
                    }
                }
            } catch (e) {
                // console.error(e);
            }
        }, 3000);

        // --- Dashboard Data Loading ---
        // (Reusing existing table logic, just simplified call)
        function loadDashboard() {
             fetch('/applied-jobs')
            .then(response => response.json())
            .then(jobs => {
                const tbody = document.getElementById('jobsBody');
                tbody.innerHTML = '';
                jobs.forEach((job, index) => {
                    const row = document.createElement('tr');
                    // Add cells... (Simplified for brevity, can copy from original)
                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td><a href="${job.Job_Link}" target="_blank">${job.Title}</a></td>
                        <td>${job.Company}</td>
                        <td>${job.HR_Name !== 'Unknown' ? `<a href="${job.HR_Link}" target="_blank">${job.HR_Name}</a>` : 'N/A'}</td>
                        <td>${job.External_Job_link !== 'Easy Applied' && job.External_Job_link ? `<a href="${job.External_Job_link}" target="_blank">External</a>` : (job.External_Job_link === 'Easy Applied' ? 'Easy Apply' : 'N/A')}</td>
                        <td>${job.Date_Applied !== 'Pending' ? '‚úì' : ''}</td>
                    `;
                    tbody.appendChild(row);
                });
            });
        }


        // --- Helpers ---
        function getVal(id) { return document.getElementById(id).value; }
        function setVal(id, val) { 
            const el = document.getElementById(id);
            if(el) el.value = val !== undefined ? val : ''; 
        }
        function getCheck(id) { return document.getElementById(id).checked; }
        function setCheck(id, val) { 
            const el = document.getElementById(id);
            if(el) el.checked = val === true; 
        }

        // --- Environment Check ---
        async function checkEnvironment() {
            try {
                const res = await fetch('/api/environment/check');
                const data = await res.json();
                
                if (!data.compatible || data.errors.length > 0) {
                    showEnvironmentWarning(data);
                } else if (data.warnings.length > 0) {
                    showEnvironmentWarning(data, true);
                }
            } catch (e) {
                console.log("Could not check environment:", e);
            }
        }
        
        function showEnvironmentWarning(data, isWarningOnly = false) {
            let warningDiv = document.getElementById('envWarning');
            if (!warningDiv) {
                warningDiv = document.createElement('div');
                warningDiv.id = 'envWarning';
                const container = document.querySelector('.container');
                container.insertBefore(warningDiv, container.firstChild);
            }
            
            const bgColor = isWarningOnly ? '#fef3c7' : '#fee2e2';
            const borderColor = isWarningOnly ? '#f59e0b' : '#ef4444';
            const textColor = isWarningOnly ? '#92400e' : '#dc2626';
            const icon = isWarningOnly ? '‚ö†Ô∏è' : 'üö´';
            const title = isWarningOnly ? 'Warning' : 'Environment Not Compatible';
            
            let html = `
                <div style="background: ${bgColor}; border: 2px solid ${borderColor}; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                    <div style="color: ${textColor}; font-weight: bold; font-size: 1.2em; margin-bottom: 10px;">
                        ${icon} ${title}
                    </div>
            `;
            
            if (data.errors.length > 0) {
                html += '<div style="margin-bottom: 10px;"><strong>Issues:</strong></div>';
                html += '<ul style="margin: 10px 0; padding-left: 20px; color: #7f1d1d;">';
                data.errors.forEach(error => {
                    html += `<li style="margin: 5px 0;">${escapeHtml(error)}</li>`;
                });
                html += '</ul>';
            }
            
            if (data.warnings.length > 0) {
                html += '<div style="margin-bottom: 10px;"><strong>Warnings:</strong></div>';
                html += '<ul style="margin: 10px 0; padding-left: 20px; color: #92400e;">';
                data.warnings.forEach(warning => {
                    html += `<li style="margin: 5px 0;">${escapeHtml(warning)}</li>`;
                });
                html += '</ul>';
            }
            
            if (data.is_serverless) {
                html += `
                    <div style="margin-top: 15px; padding: 15px; background: white; border-radius: 4px; border: 1px solid #ddd;">
                        <strong>üí° How to run this bot:</strong>
                        <ol style="margin: 10px 0; padding-left: 20px;">
                            <li>Clone this repository to your local computer</li>
                            <li>Install Python 3.8+ and Google Chrome</li>
                            <li>Run: <code style="background: #f3f4f6; padding: 2px 6px; border-radius: 3px;">pip install -r requirements.txt</code></li>
                            <li>Run: <code style="background: #f3f4f6; padding: 2px 6px; border-radius: 3px;">python app.py</code></li>
                            <li>Open <code style="background: #f3f4f6; padding: 2px 6px; border-radius: 3px;">http://localhost:5000</code> in your browser</li>
                        </ol>
                    </div>
                `;
            }
            
            html += `
                    <button onclick="document.getElementById('envWarning').style.display='none'" 
                            style="margin-top: 10px; padding: 5px 15px; background: ${borderColor}; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        Dismiss
                    </button>
                </div>
            `;
            
            warningDiv.innerHTML = html;
            
            // Disable start button if not compatible
            if (!data.compatible) {
                document.getElementById('startBtn').disabled = true;
                document.getElementById('startBtn').title = "Bot cannot run in this environment";
            }
        }

        // Init
        checkEnvironment();
        loadConfiguration();
        loadDashboard();

    </script>
</body>
</html>
